{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "storage-name": {
      "minLength": 3,
      "maxLength": 24,
      "type": "String"
    },
    "unique-id": {
      "defaultValue": "[utcNow()]",
      "type": "String"
    },
    "scripts-repo-path": {
      "defaultValue": "https://github.com/DevOpsCapgemini1/session16",
      "type": "String"
    },
    "scripts-repo-branch": {
      "defaultValue": "main",
      "type": "String"
    }
  },
  "variables": {
    "location": "[resourceGroup().location]",
    "storage": {
      "name": "[parameters('storage-name')]",
      "sku": "Standard_LRS"
    },
    "site": {
      "index": "index.html",
      "error": "error.html"
    },
    "source": {
      "repo": {
        "path": "[parameters('scripts-repo-path')]",
        "branch": "[parameters('scripts-repo-branch')]"
      }
    },
    "assets": {
      "raw": {
        "path": "[replace(variables('source').repo.path, 'github.com', 'raw.githubusercontent.com')]"
      }
    },
    "general": {
      "uniqueId": "[parameters('unique-id')]",
      "id": "[uniqueString(resourceGroup().id)]"
    },
    "custom": {
      "identity": {
        "name": "Github_Automation"
      },
      "scripts": {
        "storage": {
          "staticWebsite": {
            "enable": {
              "name": "[concat(variables('storage').name, '-website')]",
              "absolutePath": "[concat(variables('assets').raw.path, '/', variables('source').repo.branch, '/script.sh')]",
              "arguments": "[concat('--name ', variables('storage').name, ' --index ', variables('site').index, ' --error ', variables('site').error)]"
            }
          }
        }
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-06-01",
      "name": "[variables('storage').name]",
      "location": "[variables('location')]",
      "sku": {
        "name": "[variables('storage').sku]"
      },
      "kind": "StorageV2"
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "[variables('custom').scripts.storage.staticWebsite.enable.name]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/', variables('storage').name)]"
      ],
      "kind": "AzureCLI",
      "identity": {
        "type": "userAssigned",
        "userAssignedIdentities": {
          "[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities', variables('custom').identity.name)]": {}
        }
      },
      "properties": {
        "forceUpdateTag": "[variables('general').uniqueId]",
        "azCliVersion": "2.30.0",
        "arguments": "[variables('custom').scripts.storage.staticWebsite.enable.arguments]",
        "primaryScriptUri": "[variables('custom').scripts.storage.staticWebsite.enable.absolutePath]",
        "supportingScriptUris": [],
        "timeout": "PT10M",
        "cleanupPreference": "Always",
        "retentionInterval": "P1D"
      }
    }
  ],
  "outputs": {
    "website-url": {
      "type": "String",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storage').name), '2021-06-01', 'Full').properties.primaryEndpoints.web]"
    }
  }
}
